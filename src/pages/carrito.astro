---
import Layout from '../layouts/Layout.astro';
import Breadcrumb from '../components/Breadcrumb.astro';
---
<Layout>
  <div class="pagina-carrito">
    <Breadcrumb items={[
      { text: "Inicio", href: "/" },
      { text: "Carrito" }
    ]} />

    <section class="carrito">
      <div class="container">
        <div class="carrito-header">
          <h1>üõí Tu Carrito</h1>
        </div>

        <div class="carrito-content">
          <!-- Lista de Productos -->
          <div class="carrito-productos">
            <div id="carrito-lista"></div>
            <button id="vaciar-carrito" class="btn-vaciar">Vaciar carrito</button>
          </div>

          <!-- Resumen y Formulario -->
          <div class="carrito-sidebar">
            <div class="carrito-resumen">
              <h2>Resumen</h2>
              <div class="resumen-item">
                <span>Subtotal:</span>
                <span id="carrito-total">$0</span>
              </div>
       
              <div class="resumen-item">
                <span>Env√≠o:</span>
                <span id="envio-info">-</span>
              </div>
              <div class="resumen-total">
                <span>Total:</span>
                <span id="total">$0</span>
              </div>
            </div>

            <div id="formulario-datos" class="formulario-carrito">
              <h2>Datos del Pedido</h2>
              <form id="form-datos">
                <div class="form-group">
                  <label for="nombre">Nombre completo *</label>
                  <input type="text" id="nombre" required />
                </div>

                <div class="form-group">
                  <label for="aclaraciones">Aclaraciones (opcional)</label>
                  <textarea id="aclaraciones" rows="2" placeholder="Ejemplo: perrito color negro"></textarea>
                </div>

                <div class="form-group">
                  <label for="pago">Forma de pago</label>
                  <select id="pago">
                    <option value="transferencia">Transferencia</option>
                    <option value="tarjeta">Tarjeta (+25%) - hasta en 3 cuotas</option>
                  </select>
                </div>

                <div class="form-group">
                  <label for="envio">Tipo de env√≠o *</label>
                  <select id="envio" required>
                    <option value="Corrientes Envio a Domicilio">Env√≠o a Domicilio - Corrientes, Capital</option>
                    <option value="Corrientes Retiro en Sucursal">Retiro sin costo por Pasaje Alvarez 873 - Corrientes, Capital</option>
                    <option value="Correo Argentino - Sucursal">Correo Argentino - Retiro en Sucursal ($6500)</option>
                    <option value="Correo Argentino - Domicilio">Correo Argentino - Env√≠o a Domicilio ($8500)</option>
                  </select>
                </div>

                <div class="form-group" id="label-provincia" style="display: none;">
                  <label for="provincia">Provincia</label>
                  <input type="text" id="provincia" />
                </div>

                <div class="form-group" id="label-sucursal" style="display: none;">
                  <label for="sucursal">Sucursal de destino</label>
                  <input type="text" id="sucursal" />
                </div>
                
                <div class="form-group" id="label-localidad" style="display: none;">
                  <label for="localidad">Localidad</label>
                  <input type="text" id="localidad" />
                </div>
                
                <div class="form-group" id="label-direccion" style="display: none;">
                  <label for="direccion">Direcci√≥n</label>
                  <input type="text" id="direccion" />
                </div>

                <div class="form-group" id="label-cp" style="display: none;">
                  <label for="cp">C√≥digo Postal</label>
                  <input type="text" id="cp" />
                </div>

                <div class="form-group" id="label-email" style="display: none;">
                  <label for="email">Email</label>
                  <input type="email" id="email" />
                </div>

                <div class="form-group" id="label-observaciones" style="display: none;">
                  <label for="observaciones">Observaciones</label>
                  <textarea id="observaciones" rows="2"></textarea>
                </div>

                <a id="btn-finalizar" class="btn-finalizar" href="#" target="_blank">
                  <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                  </svg>
                  Realizar pedido
                </a>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script type="module" is:inline>
    import { getCarrito, saveCarrito, updateCartCount } from '/js/cart.js';

    const contenedor = document.querySelector("#carrito-lista");
    const totalEl = document.querySelector("#total");
    const envioInfoEl = document.querySelector("#envio-info");
    const carritoTotalEl = document.querySelector("#carrito-total");
    const finalizarBtn = document.querySelector("#btn-finalizar");
    const vaciarBtn = document.getElementById("vaciar-carrito");

    function actualizarFormularioEnvio() {
      const tipoEnvio = document.getElementById('envio').value;
      const mostrar = id => document.getElementById(id).style.display = 'block';
      const ocultar = id => document.getElementById(id).style.display = 'none';

      ['label-provincia', 'label-direccion', 'label-sucursal', 'label-localidad', 'label-cp', 'label-email', 'label-observaciones']
        .forEach(ocultar);

      if (tipoEnvio === 'Corrientes Envio a Domicilio') {
        mostrar('label-direccion');
      } else if (tipoEnvio === 'Correo Argentino - Sucursal') {
        mostrar('label-provincia');
        mostrar('label-sucursal');
        mostrar('label-email');
      } else if (tipoEnvio === 'Correo Argentino - Domicilio') {
        ['label-provincia', 'label-localidad', 'label-cp', 'label-direccion', 'label-email', 'label-observaciones']
          .forEach(mostrar);
      }
    }

    function renderCarrito() {
      const carrito = getCarrito();
      contenedor.innerHTML = "";
      let totalCarrito = 0;

      if (carrito.length === 0) {
        contenedor.innerHTML = `
          <div class="carrito-vacio">
            <p>Tu carrito est√° vac√≠o üïØÔ∏è</p>
            <a href="/productos" class="btn-continuar">Ver productos</a>
          </div>
        `;
        totalEl.textContent = "$0";
        carritoTotalEl.textContent = "$0";
        envioInfoEl.textContent = "-";
        finalizarBtn.style.display = "none";
        vaciarBtn.style.display = "none";
        return;
      }

      finalizarBtn.style.display = "inline-block";
      vaciarBtn.style.display = "inline-block";

      carrito.forEach((item) => {
        const card = document.createElement("div");
        card.className = "producto-carrito";

        card.innerHTML = `
          <div class="producto-imagen" onclick="window.location.href='/${item.categoria}/${item.slug}'">
            <img src="${item.image}" alt="${item.name}" />
          </div>
          <div class="producto-info">
            <h3>${item.name}</h3>
            <p class="producto-precio">${item.price}</p>
            <div class="producto-controles">
              <div class="cantidad-controles">
                <button class="btn-cantidad menos" data-slug="${item.slug}">‚àí</button>
                <span class="cantidad">${item.cantidad}</span>
                <button class="btn-cantidad mas" data-slug="${item.slug}">+</button>
              </div>
              <button data-slug="${item.slug}" class="btn-remove">Eliminar</button>
            </div>
          </div>
        `;

        contenedor.appendChild(card);
        totalCarrito += parseInt(item.price.replace("$", "")) * item.cantidad;
      });

      const get = id => document.getElementById(id)?.value || '';
      const nombre = get('nombre');
      const pago = get('pago');
      const envio = get('envio');

      let envioCosto = 0;
      let envioTexto = "";

      switch (envio) {
        case "Corrientes Retiro en Sucursal":
          envioTexto = "Sin costo";
          break;
        case "Corrientes Envio a Domicilio":
          envioTexto = "A coordinar precio";
          break;
        case "Correo Argentino - Sucursal":
          envioCosto = 6500;
          envioTexto = `$${envioCosto}`;
          break;
        case "Correo Argentino - Domicilio":
          envioCosto = 8500;
          envioTexto = `$${envioCosto}`;
          break;
        default:
          envioTexto = "A coordinar precio";
      }

      let totalConTarjeta = pago === 'tarjeta' ? Math.round(totalCarrito * 1.25) : totalCarrito;
      let totalFinal = totalConTarjeta + envioCosto;

      carritoTotalEl.textContent = `$${totalConTarjeta}`;
      envioInfoEl.textContent = envioTexto;
      totalEl.textContent = `$${totalFinal}`;

      let datosCliente = `*Datos del cliente:*\nNombre: ${nombre}\nTipo de env√≠o: ${envio}`;

      if (envio === "Corrientes Envio a Domicilio") {
        datosCliente += `\nDirecci√≥n: ${get('direccion')}`;
      } else if (envio === "Correo Argentino - Sucursal") {
        datosCliente += `\nProvincia: ${get('provincia')}\nSucursal: ${get('sucursal')}\nEmail: ${get('email')}`;
      } else if (envio === "Correo Argentino - Domicilio") {
        datosCliente += `\nProvincia: ${get('provincia')}\nLocalidad: ${get('localidad')}\nDirecci√≥n: ${get('direccion')}\nCP: ${get('cp')}\nEmail: ${get('email')}\nObservaciones: ${get('observaciones')}`;
      }

      const texto = encodeURIComponent(`Hola *Lume*, me gustar√≠a hacer un pedido de:
${carrito.map(p => `‚Ä¢ ${p.name} - ${p.price} x${p.cantidad}`).join("\n")}
Forma de pago: ${pago === 'tarjeta' ? 'Tarjeta (+25% hasta en 3 cuotas)' : 'Transferencia'}
Aclaraciones: ${get('aclaraciones') || 'Ninguna'}
*Tu carrito: $${totalConTarjeta}*
Env√≠o: ${envioTexto}
*Total a pagar: $${totalFinal}*

${datosCliente}

Gracias!`);

      finalizarBtn.href = `https://wa.me/5493795330156?text=${texto}`;
      updateCartCount();
    }

    document.addEventListener("click", (e) => {
      const slug = e.target.dataset.slug;
      if (!slug) return;

      let carrito = getCarrito();
      const index = carrito.findIndex(p => p.slug === slug);
      if (index === -1) return;

      const item = carrito[index];

      if (e.target.classList.contains("btn-remove")) {
        carrito.splice(index, 1);
      } else if (e.target.classList.contains("mas")) {
        item.cantidad++;
      } else if (e.target.classList.contains("menos")) {
        const esSouvenir = item.categoria === "souvenirs";
        const minCantidad = esSouvenir ? 10 : 1;

        if (item.cantidad > minCantidad) {
          item.cantidad--;
        } else if (!esSouvenir) {
          carrito.splice(index, 1);
        }
      }

      saveCarrito(carrito);
      renderCarrito();
    });

    vaciarBtn.addEventListener("click", () => {
      if (confirm("¬øSeguro que quer√©s vaciar el carrito?")) {
        saveCarrito([]);
        renderCarrito();
      }
    });

    document.getElementById("form-datos").addEventListener("input", renderCarrito);
    document.getElementById("envio").addEventListener("change", () => {
      actualizarFormularioEnvio();
      renderCarrito();
    });

    actualizarFormularioEnvio();
    renderCarrito();
  </script>


</Layout>